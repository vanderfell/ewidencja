<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <title>Ewidencja czasu pracy</title>
  <link rel="stylesheet" href="/css/main.css">

</head>
<body>
  <header class="app-header">
    <div class="header-content">
      <div class="logo">üóÇÔ∏è</div>
      <h1 class="app-title">EWP 0.1205</h1>
      <div class="header-meta"><%= year %> / <%= monthName %></div
    </div>
  </header>
  
  
  <ul class="tabs">
  <li class="tab active" data-tab="overview">Obs≈Çuga</li>
  <li class="tab" data-tab="employees" id="tab-employees">Pracownicy</li>
  <li class="tab"         data-tab="settings">Ustawienia</li>
</ul>

  <!-- ======== OBS≈ÅUGA ======== -->
  <div id="overview" class="tab-content active">
    <ul class="subtabs">
      <li class="subtab active" data-subtab="overview-table">Ewidencja</li>
      <li class="subtab"         data-subtab="kw-tab">Zestawienie kwartalne</li>
      <% emps.filter(e=>e.department==='Obs≈Çuga').forEach(emp=>{ %>
        <li class="subtab" data-subtab="card-<%=emp.id%>"><%=emp.full_name%></li>
      <% }) %>
    </ul>

    <div id="kw-tab" class="subtab-content"></div>

    <div id="overview-table" class="subtab-content active">
      <!-- Year/Month -->
      <form action="/" method="GET" class="date-picker">
  <div class="date-field">
    <label for="year-select">Rok</label>
    <select id="year-select" name="year" onchange="this.form.submit()">
      <% const cy = new Date().getFullYear();
         for (let y = cy - 2; y <= cy + 2; y++) { %>
        <option value="<%=y%>"<%= y===year ? ' selected' : '' %>><%= y %></option>
      <% } %>
    </select>
  </div>
  <div class="date-field">
    <label for="month-select">MiesiƒÖc</label>
    <select id="month-select" name="month" onchange="this.form.submit()">
      <% const mn = ['stycze≈Ñ','luty','marzec','kwiecie≈Ñ','maj','czerwiec',
                     'lipiec','sierpie≈Ñ','wrzesie≈Ñ','pa≈∫dziernik','listopad','grudzie≈Ñ'];
         mn.forEach((m,i)=>{ const mi = i+1; %>
        <option value="<%=mi%>"<%= mi===month ? ' selected' : '' %>><%= m %></option>
      <% }) %>
    </select>
  </div>
</form>
      <table>
        <thead>
          <tr>
            <th class="name-col">Imiƒô i nazwisko</th>
            <% dayInfos.forEach(di=>{ %>
              <th class="calendar-cell <%=di.status!=='P'?'blocked':''%>">
                <%=di.day<10?'0'+di.day:di.day%>
              </th>
            <% }) %>
            <th class="summary-sep">D</th><th>H</th>
            <th style="background:<%=CODE_COLORS['w']%>">W</th>
            <th style="background:<%=CODE_COLORS['l4']%>">L4</th>
            <th style="background:<%=CODE_COLORS['nd']%>">ND</th>
            <th style="background:<%=CODE_COLORS['bz']%>">BZ</th>
            <th style="background:<%=CODE_COLORS['op']%>">OP</th>
            <th style="background:<%=CODE_COLORS['ok']%>">OK</th>
            <th style="background:<%=CODE_COLORS['sw']%>">SW</th>
          </tr>
          <tr>
            <th></th>
            <% dayInfos.forEach(di=>{ %>
              <th class="calendar-cell <%=di.status!=='P'?'blocked':''%>"><%=di.kodDow%></th>
            <% }) %>
            <th class="summary-sep"></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
          </tr>
          <tr>
            <th></th>
            <% dayInfos.forEach(di=>{ %>
              <th class="calendar-cell status-cell <%=di.status!=='P'?'blocked':''%>"
                  data-day="<%=di.day%>"><%=di.status%></th>
            <% }) %>
            <th class="summary-sep"></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
          </tr>
        </thead>
        <tbody>
          <% emps.filter(e=>e.department==='Obs≈Çuga').forEach(emp=>{ 
               const row = summary.find(s=>s.id===emp.id);
          %>
          <tr
            data-emp="<%=emp.id%>"
            data-position="<%=emp.position%>"
            data-payroll="<%=emp.payroll_number%>"
            data-daily="<%=emp.daily_norm%>"
            data-department="<%=emp.department%>">
            <td class="name-col"><strong><%=emp.full_name%></strong></td>
            <% dayInfos.forEach(di=>{
                 const wd = wds.find(w=>w.emp_id===emp.id&&w.day===di.day)||{};
                 const code = wd.code||'';
                 const edit = di.status==='P';
                 const bg   = (code && isNaN(+code))? CODE_COLORS[code.toLowerCase()] : '';
            %>
              <td class="calendar-cell <%=edit?'':'blocked'%>" style="background:<%=bg%>">
                <% if(edit){ %>
                  <input class="cell-input"
                         data-emp="<%=emp.id%>"
                         data-year="<%=year%>"
                         data-month="<%=month%>"
                         data-day="<%=di.day%>"
                         value="<%=code%>"/>
                <% } else { %>
                  <%=code%>
                <% } %>
              </td>
            <% }) %>
            <td class="sum-days summary-sep"><%=row.days%></td>
            <td class="sum-hours"><%=row.hours%></td>
            <td class="sum-w"  style="<%=row.w  >0?'background:#ccc':''%>"><%=row.w  %></td>
            <td class="sum-l4" style="<%=row.l4 >0?'background:#ccc':''%>"><%=row.l4 %></td>
            <td class="sum-nd" style="<%=row.nd >0?'background:#ccc':''%>"><%=row.nd %></td>
            <td class="sum-bz" style="<%=row.bz >0?'background:#ccc':''%>"><%=row.bz %></td>
            <td class="sum-op" style="<%=row.op >0?'background:#ccc':''%>"><%=row.op %></td>
            <td class="sum-ok" style="<%=row.ok >0?'background:#ccc':''%>"><%=row.ok %></td>
            <td class="sum-sw" style="<%=row.sw >0?'background:#ccc':''%>"><%=row.sw %></td>
          </tr>
          <% }) %>
        </tbody>
      </table>

      <button id="print-cards">Drukuj karty</button>
    </div>

    <!-- indywidualne karty pracownik√≥w -->
    <% emps.filter(e=>e.department==='Obs≈Çuga').forEach(emp=>{ %>
      <div id="card-<%=emp.id%>" class="subtab-content"></div>
    <% }) %>
  </div>

<!-- pracownicy -->
<div id="employees" class="tab-content">
  <div id="employees-container">
    <!-- tutaj za≈Çadowany zostanie profile_menu.ejs -->
  </div>
</div>


  <!-- ======== USTAWIENIA ======== -->
  <%- include('settings') %>

  <!-- CONTEXT MENUS -->
  <ul id="emp-context-menu">
    <li id="ctx-profile">Wy≈õwietl profil‚Ä¶</li>
    <li id="ctx-edit">Edytuj pracownika‚Ä¶</li>
    <li id="ctx-note">Notatka</li>
    <li id="ctx-delete">Usu≈Ñ pracownika</li>
  </ul>
  <ul id="day-context-menu">
    <li data-code="≈ö">≈ö ‚Äì ≈öwiƒôto</li>
    <li data-code="P">P ‚Äì Dzie≈Ñ roboczy</li>
    <li data-code="-">‚Äì ‚Äì Weekend</li>
    <li data-code="DW">DW ‚Äì Dzie≈Ñ wolny</li>
    <li data-code="">Usu≈Ñ nadpisanie</li>
  </ul>

  <!-- MODAL EDIT -->
  <div id="emp-modal">
    <div class="modal-content">
      <h2>Edytuj pracownika</h2>
      <form id="emp-edit-form">
        <label>Imiƒô i nazwisko:<br><input name="full_name" required/></label>
        <label>Stanowisko:<br><input name="position"/></label>
        <label>Numer ewidencyjny:<br><input name="payroll_number"/></label>
        <label>Norma dzienna (h):<br><input type="number" name="daily_norm" step="0.25" required/></label>
        <label>Dzia≈Ç:<br>
          <select name="department" required>
            <option value="Obs≈Çuga">Obs≈Çuga</option>
            <option value="Nauczyciel">Nauczyciel</option>
          </select>
        </label>
        <div class="modal-buttons">
          <button type="button" id="modal-cancel">Anuluj</button>
          <button type="submit">Zapisz</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- MODAL: Notatka -->
<div id="note-modal" style="display:none; position:fixed; top:0; left:0;
                           width:100%; height:100%; background:rgba(0,0,0,0.5);
                           align-items:center; justify-content:center; z-index:1002;">
  <div class="modal-content" style="background:#fff; padding:1em; border-radius:4px;
                                     width:auto; max-width:90%; max-height:90%; overflow:auto;">
    <h2>Notatka</h2>
    <textarea id="note-text" style="width:400px; height:400px; margin-top:0.5em;"></textarea>
    <div class="modal-buttons" style="margin-top:1em; text-align:right;">
      <button type="button" id="note-cancel">Anuluj</button>
      <button type="button" id="note-delete" style="margin-right:0.5em;">Usu≈Ñ</button>
      <button type="button" id="note-save">Zapisz</button>
    </div>
  </div>
</div>


  <script>window.CODE_COLORS=<%- JSON.stringify(CODE_COLORS) %>;</script>
  <script>window.YEAR=<%=year%>; window.MONTH=<%=month%>;</script>
  <script src="/script.js"></script>
</body>
</html>
