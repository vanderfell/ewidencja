<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Profil pracownika</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
    /* Sidebar */
    .sidebar { width: 280px; background: #f5f5f5; overflow-y: auto; border-right: 1px solid #ccc; padding: 1rem; }
    .sidebar h2 { margin-top: 0; font-size: 1.2rem; }
    .dept { margin-bottom: 1rem; }
    .dept-header { font-weight: bold; cursor: pointer; padding: 0.5rem; background: #e0e0e0; border-radius: 4px; }
    .dept-header:hover { background: #d0d0d0; }
    .dept-list { list-style: none; margin: 0.5rem 0 0; padding: 0; display: none; }
    .dept-list li { margin: 0; }
    .dept-list a { display: block; padding: 0.4rem 0.8rem; color: #333; text-decoration: none; border-radius: 4px; }
    .dept-list a:hover, .dept-list a.active { background: #ddd; }
    /* Content */
    .content { flex: 1; padding: 1.5rem; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
    th, td { border: 1px solid #999; padding: 8px; text-align: left; }
    h1, h2 { margin-top: 1em; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Pracownicy według działów</h2>
    <% const byDept = employees.reduce((acc, e) => {
         const deptKey = e.department || 'Bez działu';
         (acc[deptKey] = acc[deptKey]||[]).push(e);
         return acc;
       }, {}); %>
    <% Object.entries(byDept).forEach(([dept, list]) => { %>
      <div class="dept">
        <div class="dept-header"><%= dept %> (<%= list.length %>)</div>
        <ul class="dept-list" <%= list.some(e=>e.id===selectedId) ? 'style="display:block;"' : '' %>>
          <% list.forEach(e => { %>
            <li>
              <a href="/employees/<%= e.id %>/profile" class="<%= e.id === selectedId ? 'active' : '' %>">
                <%= e.full_name %>
              </a>
            </li>
          <% }) %>
        </ul>
      </div>
    <% }) %>
  </div>

  <div class="content">
    <% if (!emp) { %>
      <p>Wybierz pracownika z lewej listy.</p>
    <% } else { %>
      <% // tablica nazw miesięcy %>
      <% const monthNames = [
           'styczeń','luty','marzec','kwiecień','maj','czerwiec',
           'lipiec','sierpień','wrzesień','październik','listopad','grudzień'
         ];
      %>

      <h1><%= emp.full_name %> (ID: <%= emp.id %>)</h1>

      <table>
        <tr><th>Stanowisko</th><td><%= emp.position %></td></tr>
        <tr><th>Dział</th><td><%= emp.department %></td></tr>
        <tr><th>Norma dzienna (h)</th><td><%= emp.daily_norm %></td></tr>
      </table>

      <h2>Podsumowanie miesięczne</h2>
      <table>
        <thead>
          <tr>
            <th>Rok</th>
            <th>Miesiąc</th>
            <th>Godziny</th>
            <th>Dni</th>
          </tr>
        </thead>
        <tbody>
          <% summary.forEach(s => { %>
            <tr>
              <td><%= s.year %></td>
              <td><%= monthNames[s.month - 1] %></td>
              <td><%= s.hours %></td>
              <td><%= s.days %></td>
            </tr>
          <% }) %>
          <% if (!summary.length) { %>
            <tr>
              <td colspan="4" style="text-align:center;">Brak danych</td>
            </tr>
          <% } %>
        </tbody>
      </table>

      <h2>Podsumowanie absencji</h2>
      <table>
        <thead>
          <tr>
            <th>Rok</th>
            <th>Miesiąc</th>
            <% Object.entries(CODE_COLORS).forEach(([code,color]) => { %>
              <th style="background:<%= color %>; color:#000;"><%= code.toUpperCase() %></th>
            <% }) %>
          </tr>
        </thead>
        <tbody>
          <% absSummary.forEach(a => { %>
            <tr>
              <td><%= a.year %></td>
              <td><%= monthNames[a.month - 1] %></td>
              <% Object.keys(CODE_COLORS).forEach(code => { %>
                <td><%= a[code] || 0 %></td>
              <% }) %>
            </tr>
          <% }) %>
          <% if (!absSummary.length) { %>
            <tr>
              <td colspan="<%= 2 + Object.keys(CODE_COLORS).length %>" style="text-align:center;">
                Brak danych
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
      
      
      <h2>Umowy</h2>
<table id="contracts-table">
  <thead>
    <tr>
      <th>Data od</th>
      <th>Data do</th>
      <th>Norma dzienna (h)</th>
      <th>Akcje</th>
    </tr>
  </thead>
  <tbody>
    <% contracts.forEach(c => { %>
      <tr data-id="<%= c.id %>">
        <td><input type="date" class="c-start" value="<%= c.start_date %>"></td>
        <td><input type="date" class="c-end"   value="<%= c.end_date || '' %>"></td>
        <td><input type="number" class="c-dnorm" step="0.25" value="<%= c.daily_norm %>"></td>
        <td>
          <button class="c-save">Zapisz</button>
          <button class="c-del">Usuń</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<h3>Dodaj nową umowę</h3>
<form id="add-contract-form">
  <input type="date"   name="start_date"       required>
  <input type="date"   name="end_date"         placeholder="bez końca">
  <input type="number" name="daily_norm" step="0.25" value="8" required>
  <button type="submit">Dodaj</button>
</form>

<script>
;(async()=>{
  const empId = <%= selectedId %>;
  const tbl   = document.getElementById('contracts-table');

  // Zapis/aktualizacja istniejącej umowy
  tbl.addEventListener('click', async e=>{
    if (e.target.matches('.c-save')) {
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      const start_date = tr.querySelector('.c-start').value;
      const end_date   = tr.querySelector('.c-end').value;
      const daily_norm = tr.querySelector('.c-dnorm').value;
      const res = await fetch('/api/contracts/'+id, {
        method:'PUT',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ start_date, end_date, daily_norm })
      });
      const js  = await res.json();
      alert(js.ok ? 'Umowa zaktualizowana.' : 'Błąd: '+js.message);
    }
    if (e.target.matches('.c-del')) {
      if (!confirm('Na pewno usunąć tę umowę?')) return;
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      const res= await fetch('/api/contracts/'+id, { method:'DELETE' });
      const js = await res.json();
      if (js.ok) tr.remove();
      else alert('Błąd: '+js.message);
    }
  });

  // Dodanie nowej umowy
  document.getElementById('add-contract-form')
    .addEventListener('submit', async e=>{
      e.preventDefault();
      const sd = e.target.start_date.value;
      const ed = e.target.end_date.value;
      const dn = e.target.daily_norm.value;
      const res= await fetch('/api/contracts', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ emp_id:empId, start_date:sd, end_date:ed, daily_norm:dn })
      });
      const js= await res.json();
      if (js.ok) location.reload();
      else alert('Błąd: '+js.message);
    });
})();
</script>


      <h2>Notatki</h2>
      <table>
        <thead>
          <tr><th>Rok</th><th>Miesiąc</th><th>Notatka</th></tr>
        </thead>
        <tbody>
          <% notes.forEach(n => { %>
            <tr>
              <td><%= n.year %></td>
              <td><%= monthNames[n.month - 1] %></td>
              <td><%= n.note %></td>
            </tr>
          <% }) %>
          <% if (!notes.length) { %>
            <tr>
              <td colspan="3" style="text-align:center;">Brak notatek</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    <% } %>
  </div>

  <script>
    // sidebar
    const sidebar = document.querySelector('.sidebar');
    sidebar.addEventListener('click', e => {
      const header = e.target.closest('.dept-header');
      if (header) {
        const list = header.nextElementSibling;
        list.style.display = list.style.display === 'block' ? 'none' : 'block';
      }
    });

    // AJAX load profile
    document.querySelectorAll('.dept-list a').forEach(link => {
      link.addEventListener('click', async e => {
        e.preventDefault();
        const url = link.href;
        history.pushState(null,'',url);
        const html = await (await fetch(url)).text();
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        document.querySelector('.content').innerHTML =
          tmp.querySelector('.content').innerHTML;
        // odśwież aktywną klasę i rozwinięcie...
      });
    });

    window.addEventListener('popstate', () => location.reload());
  </script>
</body>
</html>
