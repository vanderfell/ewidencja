<style>
  #vac-table  { border-collapse:collapse;width:100%;margin-top:.8em;font-size:.85em; }
  #vac-table th, #vac-table td { border:1px solid #999;padding:4px;text-align:center; }
  #vac-table input { width:70px;text-align:center; }
  #vac-table tr:nth-child(even){background:#f7f7f7;}
</style>

<h2>Urlopy wypoczynkowe – Obsługa</h2>

<table id="vac-table">
  <thead>
    <tr>
      <th rowspan="2">Pracownik</th>
      <% years.forEach(y=>{ %>
          <th colspan="3"><%= y %></th>
      <% }) %>
    </tr>
    <tr>
      <% years.forEach(()=>{ %>
        <th>Limit</th><th>Wyk.</th><th>Poz.</th>
      <% }) %>
    </tr>
  </thead>
  <tbody>
    <% data.forEach(row=>{ %>
      <tr data-emp="<%= row.id %>">
        <td style="text-align:left"><%= row.full_name %></td>
        <% years.forEach(y=>{ const r=row[y]||{limit:0,used:0,left:0}; %>
           <td>
             <input class="lim-inp" data-year="<%=y%>" value="<%=r.limit%>">
           </td>
           <td><%= r.used %></td>
           <td><%= r.left %></td>
        <% }) %>
      </tr>
    <% }) %>
  </tbody>
</table>

<button id="save-vac" style="margin-top:1em;">Zapisz zmiany</button>

<script>
(() =>{
  const tab   = document.getElementById('vac-table');
  const save  = document.getElementById('save-vac');
  if(!tab) return;

  /* zbierz & wyślij */
  save.onclick = async ()=>{
    const rows = [...tab.querySelectorAll('tbody tr')];
    const payload = [];
    rows.forEach(tr=>{
      const emp = +tr.dataset.emp;
      tr.querySelectorAll('.lim-inp').forEach(inp=>{
        payload.push({
          emp_id: emp,
          year  : +inp.dataset.year,
          limit_days: +inp.value||0
        });
      });
    });

    /* POST-ujemy każdy rekord osobno (najprościej) */
    for(const p of payload){
      const r = await fetch('/api/vacations',{
         method:'POST',headers:{'Content-Type':'application/json'},
         body:JSON.stringify(p)
      }).then(r=>r.json());
      if(!r.ok){ alert('Błąd zapisu'); return;}
    }
    alert('Zapisano.');
    location.reload();
  };
})();
</script>
